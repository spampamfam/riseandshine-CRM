<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - CRM Pro</title>
    <link rel="stylesheet" href="../assets/styles.css">
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
</head>
<body>
    <div class="container">
        <header class="header">
            <nav class="nav">
                <div class="nav-brand">
                    <a href="../index.html" style="text-decoration: none; color: inherit;">
                        <h1>üìä CRM Pro</h1>
                    </a>
                </div>
                <div class="nav-menu">
                    <button class="theme-toggle" id="themeToggle">
                        <span class="theme-icon">üåô</span>
                    </button>
                    <a href="register.html" class="btn btn-secondary">Sign Up</a>
                </div>
            </nav>
        </header>

        <main class="main">
            <div class="form-container">
                <h1 class="form-title">Welcome Back</h1>
                <p class="text-center mb-4" style="color: var(--text-secondary);">
                    Sign in to your account to continue
                </p>
                
                <form id="loginForm" class="login-form">
                    <div class="form-group">
                        <label for="email" class="form-label">Email Address</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="form-input" 
                            required 
                            placeholder="Enter your email"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            class="form-input" 
                            required 
                            placeholder="Enter your password"
                        >
                    </div>
                    
                    <div class="form-checkbox">
                        <input type="checkbox" id="rememberMe" name="rememberMe">
                        <label for="rememberMe">Remember me for 30 days</label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary form-submit">
                        <span id="submitText">Sign In</span>
                        <span id="loadingText" class="hidden">Signing in...</span>
                    </button>
                </form>
                
                <div class="form-link">
                    <p>Don't have an account? <a href="register.html">Sign up here</a></p>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/theme.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // Login form handling
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('loginForm');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Show loading state
                submitText.classList.add('hidden');
                loadingText.classList.remove('hidden');
                
                const formData = new FormData(loginForm);
                const email = formData.get('email');
                const password = formData.get('password');
                const rememberMe = formData.get('rememberMe') === 'on';
                
                try {
                    console.log('üîê Attempting login for:', email);
                    
                    // Add timeout to prevent hanging
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

                    const response = await fetch('https://riseandshine-crm-production.up.railway.app/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        signal: controller.signal,
                        body: JSON.stringify({
                            email,
                            password,
                            rememberMe
                        })
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log('üîê Login response status:', response.status);
                    console.log('üîê Login response headers:', response.headers);
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        console.log('üîê Login successful, cookies after login:', document.cookie);
                        
                        // Store token in localStorage as fallback
                        if (data.token) {
                            localStorage.setItem('authToken', data.token);
                        }
                        
                        // Redirect to dashboard immediately
                        window.location.href = 'dashboard.html';
                    } else {
                        throw new Error(data.error || 'Login failed');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    
                    let errorMessage = 'Login failed. Please try again.';
                    if (error.name === 'AbortError') {
                        errorMessage = 'Login timed out. Please try again.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    // Show error message
                    if (window.crmApp) {
                        window.crmApp.showNotification(errorMessage, 'error');
                    }
                    
                    // Reset form
                    loginForm.reset();
                } finally {
                    // Hide loading state
                    submitText.classList.remove('hidden');
                    loadingText.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html> 